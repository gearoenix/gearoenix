#include "gx-gl-shd-ssao-resolve.hpp"
#ifdef GX_RENDER_OPENGL_ENABLED

namespace {
constexpr auto vertex_shader_body = R"SHADER(
layout(location = 0) in vec2 position;

out vec2 out_uv;

void main() {
    gl_Position = vec4(position, 0.0, 1.0);
    out_uv = position * 0.5 + 0.5;
}
)SHADER";

constexpr auto fragment_shader_body = R"SHADER(
const float ssao_samples_weight = 1.0 / 86.0;
const int ssao_samples_count = 86;
const vec3 ssao_samples[ssao_samples_count] = vec3[ssao_samples_count](
 vec3(-0.5773502691896258, 0.5773502691896258, 0.5773502691896258),
 vec3(-0.30290544652768625, 0.6738873386790492, 0.6738873386790492),
 vec3(-0.6738873386790492, 0.30290544652768625, 0.6738873386790492),
 vec3(-0.3676719239173477, 0.36139654819928557, 0.8568604853256786),
 vec3(0.0, 0.7071067811865476, 0.7071067811865476),
 vec3(0.30290544652768625, 0.6738873386790492, 0.6738873386790492),
 vec3(0.0, 0.3826834323650898, 0.9238795325112867),
 vec3(0.3676719239173477, 0.36139654819928557, 0.8568604853256786),
 vec3(-0.7071067811865476, 0.0, 0.7071067811865476),
 vec3(-0.3826834323650898, 0.0, 0.9238795325112867),
 vec3(-0.6738873386790492, -0.30290544652768625, 0.6738873386790492),
 vec3(-0.3676719239173477, -0.36139654819928557, 0.8568604853256786),
 vec3(0.0, 0.0, 1.0),
 vec3(0.3826834323650898, 0.0, 0.9238795325112867),
 vec3(0.0, -0.3826834323650898, 0.9238795325112867),
 vec3(0.3676719239173477, -0.36139654819928557, 0.8568604853256786),
 vec3(-0.5773502691896258, 0.5773502691896258, -0.5773502691896258),
 vec3(-0.30290544652768625, 0.6738873386790492, -0.6738873386790492),
 vec3(-0.6738873386790492, 0.30290544652768625, -0.6738873386790492),
 vec3(-0.3676719239173477, 0.36139654819928557, -0.8568604853256786),
 vec3(0.0, 0.7071067811865476, -0.7071067811865476),
 vec3(0.30290544652768625, 0.6738873386790492, -0.6738873386790492),
 vec3(0.0, 0.3826834323650898, -0.9238795325112867),
 vec3(0.3676719239173477, 0.36139654819928557, -0.8568604853256786),
 vec3(-0.7071067811865476, 0.0, -0.7071067811865476),
 vec3(-0.3826834323650898, 0.0, -0.9238795325112867),
 vec3(-0.6738873386790492, -0.30290544652768625, -0.6738873386790492),
 vec3(-0.3676719239173477, -0.36139654819928557, -0.8568604853256786),
 vec3(0.0, 0.0, -1.0),
 vec3(0.3826834323650898, 0.0, -0.9238795325112867),
 vec3(0.0, -0.3826834323650898, -0.9238795325112867),
 vec3(0.3676719239173477, -0.36139654819928557, -0.8568604853256786),
 vec3(0.5773502691896258, -0.5773502691896258, 0.5773502691896258),
 vec3(0.6738873386790492, -0.30290544652768625, 0.6738873386790492),
 vec3(0.6738873386790492, -0.6738873386790492, 0.30290544652768625),
 vec3(0.8568604853256786, -0.3676719239173477, 0.36139654819928557),
 vec3(0.7071067811865476, 0.0, 0.7071067811865476),
 vec3(0.6738873386790492, 0.30290544652768625, 0.6738873386790492),
 vec3(0.9238795325112867, 0.0, 0.3826834323650898),
 vec3(0.8568604853256786, 0.3676719239173477, 0.36139654819928557),
 vec3(0.7071067811865476, -0.7071067811865476, 0.0),
 vec3(0.9238795325112867, -0.3826834323650898, 0.0),
 vec3(0.6738873386790492, -0.6738873386790492, -0.30290544652768625),
 vec3(0.8568604853256786, -0.3676719239173477, -0.36139654819928557),
 vec3(1.0, 0.0, 0.0),
 vec3(0.9238795325112867, 0.3826834323650898, 0.0),
 vec3(0.9238795325112867, 0.0, -0.3826834323650898),
 vec3(0.8568604853256786, 0.3676719239173477, -0.36139654819928557),
 vec3(-0.5773502691896258, -0.5773502691896258, 0.5773502691896258),
 vec3(-0.6738873386790492, -0.6738873386790492, 0.30290544652768625),
 vec3(-0.8568604853256786, -0.3676719239173477, 0.36139654819928557),
 vec3(-0.7071067811865476, -0.7071067811865476, 0.0),
 vec3(-0.9238795325112867, -0.3826834323650898, 0.0),
 vec3(-0.9238795325112867, 0.0, 0.3826834323650898),
 vec3(-0.8568604853256786, 0.3676719239173477, 0.36139654819928557),
 vec3(-1.0, 0.0, 0.0),
 vec3(-0.9238795325112867, 0.3826834323650898, 0.0),
 vec3(-0.6738873386790492, -0.6738873386790492, -0.30290544652768625),
 vec3(-0.8568604853256786, -0.3676719239173477, -0.36139654819928557),
 vec3(-0.5773502691896258, -0.5773502691896258, -0.5773502691896258),
 vec3(-0.9238795325112867, 0.0, -0.3826834323650898),
 vec3(-0.8568604853256786, 0.3676719239173477, -0.36139654819928557),
 vec3(-0.6738873386790492, 0.6738873386790492, 0.30290544652768625),
 vec3(-0.3676719239173477, 0.8568604853256786, 0.36139654819928557),
 vec3(-0.7071067811865476, 0.7071067811865476, 0.0),
 vec3(-0.3826834323650898, 0.9238795325112867, 0.0),
 vec3(0.0, 0.9238795325112867, 0.3826834323650898),
 vec3(0.3676719239173477, 0.8568604853256786, 0.36139654819928557),
 vec3(0.0, 1.0, 0.0),
 vec3(0.3826834323650898, 0.9238795325112867, 0.0),
 vec3(-0.6738873386790492, 0.6738873386790492, -0.30290544652768625),
 vec3(-0.3676719239173477, 0.8568604853256786, -0.36139654819928557),
 vec3(0.0, 0.9238795325112867, -0.3826834323650898),
 vec3(0.3676719239173477, 0.8568604853256786, -0.36139654819928557),
 vec3(-0.30290544652768625, -0.6738873386790492, 0.6738873386790492),
 vec3(0.0, -0.7071067811865476, 0.7071067811865476),
 vec3(-0.3676719239173477, -0.8568604853256786, 0.36139654819928557),
 vec3(0.0, -0.9238795325112867, 0.3826834323650898),
 vec3(0.30290544652768625, -0.6738873386790492, 0.6738873386790492),
 vec3(0.3676719239173477, -0.8568604853256786, 0.36139654819928557),
 vec3(-0.3826834323650898, -0.9238795325112867, 0.0),
 vec3(0.0, -1.0, 0.0),
 vec3(-0.3676719239173477, -0.8568604853256786, -0.36139654819928557),
 vec3(0.0, -0.9238795325112867, -0.3826834323650898),
 vec3(0.3826834323650898, -0.9238795325112867, 0.0),
 vec3(0.3676719239173477, -0.8568604853256786, -0.36139654819928557)
);
uniform mat4 vp; 
uniform vec4 ssao_radius_move_start_end;

uniform sampler2D position_depth;
uniform sampler2D normal_ao;

in vec2 out_uv;

out float ssao_value;

void main() {
    vec3 pos = texture(position_depth, out_uv).xyz;
    vec3 nrm = texture(normal_ao, out_uv).xyz;
    ssao_value = 0.0;
    for(int i = 0; i < ssao_samples_count; ++i) {
        vec3 smp = ssao_samples[i];
        smp *= ((1.5 * step(0.0, dot(nrm, smp)) - 0.5) * ssao_radius_move_start_end.x) + (nrm * ssao_radius_move_start_end.y);
        smp += pos;
        vec4 p = vp * vec4(smp, 1.0);
        smp = p.xyz / p.w;
        smp *= 0.5;
        smp += 0.5;
        float coverage = smp.z - texture(position_depth, smp.xy).w;
        ssao_value += step(coverage, ssao_radius_move_start_end.z) + step(ssao_radius_move_start_end.w, coverage);
    }
    ssao_value = smoothstep(0.0, 1.0, ssao_value * ssao_samples_weight);
}
)SHADER";
}

gearoenix::gl::shader::SsaoResolve::SsaoResolve()
{
    set_vertex_shader(get_common_shader_starter() + vertex_shader_body);
    set_fragment_shader(get_common_shader_starter() + fragment_shader_body);
    link();
    GX_GL_SHADER_SET_TEXTURE_INDEX_STARTING;
    GX_GL_THIS_GET_UNIFORM(vp);
    GX_GL_THIS_GET_UNIFORM(ssao_radius_move_start_end);
    GX_GL_THIS_GET_UNIFORM_TEXTURE(position_depth);
    GX_GL_THIS_GET_UNIFORM_TEXTURE(normal_ao);
}

gearoenix::gl::shader::SsaoResolve::~SsaoResolve() = default;

void gearoenix::gl::shader::SsaoResolve::bind(uint& current_shader) const
{
    if (shader_program == current_shader) {
        return;
    }
    Shader::bind(current_shader);
    GX_GL_SHADER_SET_TEXTURE_INDEX_UNIFORM(position_depth);
    GX_GL_SHADER_SET_TEXTURE_INDEX_UNIFORM(normal_ao);
}

#endif